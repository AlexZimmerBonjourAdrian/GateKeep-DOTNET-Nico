<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/src/GateKeep.Api/Endpoints/Auth/AuthEndpoints.cs">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/src/GateKeep.Api/Endpoints/Auth/AuthEndpoints.cs" />
              <option name="originalContent" value="using GateKeep.Api.Contracts.Security;&#10;using GateKeep.Api.Contracts.Usuarios;&#10;using GateKeep.Api.Application.Security;&#10;using GateKeep.Api.Application.Usuarios;&#10;using GateKeep.Infrastructure.QrCodes;&#10;using System.Security.Claims;&#10;&#10;namespace GateKeep.Api.Endpoints.Auth;&#10;&#10;public static class AuthEndpoints&#10;{&#10;    public static IEndpointRouteBuilder MapAuthEndpoints(this IEndpointRouteBuilder app)&#10;    {&#10;        var group = app.MapGroup(&quot;/auth&quot;).WithTags(&quot;Authentication&quot;);&#10;&#10;        // Login endpoint - PÚBLICO (sin restricciones de seguridad)&#10;        group.MapPost(&quot;/login&quot;, async (LoginRequest request, IAuthService authService) =&gt;&#10;        {&#10;            if (string.IsNullOrEmpty(request.Email) || string.IsNullOrEmpty(request.Password))&#10;            {&#10;                return Results.BadRequest(new AuthResponse&#10;                {&#10;                    IsSuccess = false,&#10;                    ErrorMessage = &quot;Email y contraseña son requeridos&quot;&#10;                });&#10;            }&#10;&#10;            var result = await authService.LoginAsync(request.Email, request.Password);&#10;            &#10;            if (!result.IsSuccess)&#10;            {&#10;                return Results.Unauthorized();&#10;            }&#10;&#10;            var response = new AuthResponse&#10;            {&#10;                IsSuccess = true,&#10;                Token = result.Token,&#10;                RefreshToken = result.RefreshToken,&#10;                ExpiresAt = result.ExpiresAt,&#10;                User = new UserInfoResponse&#10;                {&#10;                    Id = result.User!.Id,&#10;                    Email = result.User.Email,&#10;                    Nombre = result.User.Nombre,&#10;                    Apellido = result.User.Apellido,&#10;                    TipoUsuario = result.User.Rol.ToString(),&#10;                    Telefono = result.User.Telefono,&#10;                    FechaAlta = result.User.FechaAlta&#10;                }&#10;            };&#10;&#10;            return Results.Ok(response);&#10;        })&#10;        .AllowAnonymous()&#10;        .WithName(&quot;Login&quot;)&#10;        .WithSummary(&quot;Iniciar sesión&quot;)&#10;        .WithDescription(&quot;Autentica un usuario y retorna un token JWT. Endpoint público sin restricciones de seguridad.&quot;)&#10;        .Produces&lt;AuthResponse&gt;(200)&#10;        .Produces(401)&#10;        .Produces(400);&#10;&#10;        // Register endpoint - SOLO ADMINS&#10;        group.MapPost(&quot;/register&quot;, async (RegisterRequest request, IAuthService authService) =&gt;&#10;        {&#10;            if (string.IsNullOrEmpty(request.Email) || string.IsNullOrEmpty(request.Password) ||&#10;                string.IsNullOrEmpty(request.Nombre) || string.IsNullOrEmpty(request.Apellido))&#10;            {&#10;                return Results.BadRequest(new AuthResponse&#10;                {&#10;                    IsSuccess = false,&#10;                    ErrorMessage = &quot;Email, contraseña, nombre y apellido son requeridos&quot;&#10;                });&#10;            }&#10;&#10;            if (request.Password != request.ConfirmPassword)&#10;            {&#10;                return Results.BadRequest(new AuthResponse&#10;                {&#10;                    IsSuccess = false,&#10;                    ErrorMessage = &quot;Las contraseñas no coinciden&quot;&#10;                });&#10;            }&#10;&#10;            var result = await authService.RegisterAsync(&#10;                request.Email,&#10;                request.Password,&#10;                request.Nombre,&#10;                request.Apellido,&#10;                request.Telefono,&#10;                request.Rol&#10;            );&#10;            &#10;            if (!result.IsSuccess)&#10;            {&#10;                return Results.BadRequest(new AuthResponse&#10;                {&#10;                    IsSuccess = false,&#10;                    ErrorMessage = result.ErrorMessage ?? &quot;Error al registrar el usuario&quot;&#10;                });&#10;            }&#10;&#10;            var response = new AuthResponse&#10;            {&#10;                IsSuccess = true,&#10;                Token = result.Token,&#10;                RefreshToken = result.RefreshToken,&#10;                ExpiresAt = result.ExpiresAt,&#10;                User = new UserInfoResponse&#10;                {&#10;                    Id = result.User!.Id,&#10;                    Email = result.User.Email,&#10;                    Nombre = result.User.Nombre,&#10;                    Apellido = result.User.Apellido,&#10;                    TipoUsuario = result.User.Rol.ToString(),&#10;                    Telefono = result.User.Telefono,&#10;                    FechaAlta = result.User.FechaAlta&#10;                }&#10;            };&#10;&#10;            return Results.Ok(response);&#10;        })&#10;        .WithName(&quot;Register&quot;)&#10;        .WithSummary(&quot;Registrar nuevo usuario&quot;)&#10;        .WithDescription(&quot;Registra un nuevo usuario en el sistema. Solo accesible por Administradores.&quot;)&#10;        .Produces&lt;AuthResponse&gt;(200)&#10;        .Produces(400)&#10;        .Produces(401)&#10;        .RequireAuthorization(&quot;AdminOnly&quot;);&#10;&#10;        // Generar código QR con el JWT actual&#10;        group.MapGet(&quot;/qr&quot;, (&#10;            HttpContext httpContext,&#10;            QrCodeGenerator qr&#10;        ) =&gt;&#10;        {&#10;            // 1) Permitir token explícito por query: /auth/qr?token=...&#10;            string? token = httpContext.Request.Query[&quot;token&quot;];&#10;&#10;            // 2) Si no viene por query, intentar extraer del header Authorization: Bearer &lt;token&gt;&#10;            if (string.IsNullOrWhiteSpace(token))&#10;            {&#10;                if (httpContext.Request.Headers.TryGetValue(&quot;Authorization&quot;, out var authHeader))&#10;                {&#10;                    var value = authHeader.ToString();&#10;                    const string prefix = &quot;Bearer &quot;;&#10;                    if (value.StartsWith(prefix, StringComparison.OrdinalIgnoreCase))&#10;                    {&#10;                        token = value.Substring(prefix.Length).Trim();&#10;                    }&#10;                }&#10;            }&#10;&#10;            if (string.IsNullOrWhiteSpace(token))&#10;            {&#10;                return Results.BadRequest(new { message = &quot;Falta el token JWT (use query 'token' o Authorization: Bearer ...)&quot; });&#10;            }&#10;&#10;            // Generar PNG con el token (solo Windows por dependencia de System.Drawing)&#10;            if (!OperatingSystem.IsWindows())&#10;            {&#10;                return Results.Problem(&quot;Generación de QR no soportada en esta plataforma (requiere Windows)&quot;, statusCode: 501);&#10;            }&#10;&#10;            // Tamaño opcional del QR: ?w=250&amp;h=250&#10;            int w = 250;&#10;            int h = 250;&#10;            if (int.TryParse(httpContext.Request.Query[&quot;w&quot;], out var wParsed) &amp;&amp; wParsed &gt; 0)&#10;            {&#10;                w = wParsed;&#10;            }&#10;            if (int.TryParse(httpContext.Request.Query[&quot;h&quot;], out var hParsed) &amp;&amp; hParsed &gt; 0)&#10;            {&#10;                h = hParsed;&#10;            }&#10;&#10;            var pngBytes = qr.Generate(token, w, h);&#10;            return Results.File(pngBytes, contentType: &quot;image/png&quot;, fileDownloadName: null, enableRangeProcessing: false);&#10;        })&#10;        .WithName(&quot;GetAuthTokenQr&quot;)&#10;        .WithSummary(&quot;Generar código QR del JWT&quot;)&#10;        .WithDescription(&quot;Devuelve una imagen PNG con el QR que contiene el token JWT. Acepta query 'token' o usa el header Authorization.&quot;)&#10;        .Produces(200)&#10;        .Produces(400)&#10;        .RequireAuthorization();&#10;&#10;        // Crear usuarios de prueba - PÚBLICO (para testing)&#10;        group.MapPost(&quot;/create-test-users&quot;, async (&#10;            IUsuarioFactory factory, &#10;            IUsuarioRepository repo,&#10;            IPasswordService passwordService) =&gt;&#10;        {&#10;            var usuariosCreados = new List&lt;object&gt;();&#10;            var usuariosExistentes = new List&lt;object&gt;();&#10;            var totalCreados = 0;&#10;            var totalExistentes = 0;&#10;&#10;            // Datos de usuarios de prueba con contraseñas en texto plano&#10;            var usuariosTest = new[]&#10;            {&#10;                // Administradores&#10;                new { Email = &quot;admin1@gatekeep.com&quot;, Nombre = &quot;Admin&quot;, Apellido = &quot;Uno&quot;, Telefono = &quot;+1234567891&quot;, Password = &quot;admin123&quot;, Tipo = &quot;Admin&quot; },&#10;                new { Email = &quot;admin2@gatekeep.com&quot;, Nombre = &quot;Admin&quot;, Apellido = &quot;Dos&quot;, Telefono = &quot;+1234567892&quot;, Password = &quot;admin123&quot;, Tipo = &quot;Admin&quot; },&#10;                new { Email = &quot;admin3@gatekeep.com&quot;, Nombre = &quot;Admin&quot;, Apellido = &quot;Tres&quot;, Telefono = &quot;+1234567893&quot;, Password = &quot;admin123&quot;, Tipo = &quot;Admin&quot; },&#10;                &#10;                // Estudiantes&#10;                new { Email = &quot;estudiante1@gatekeep.com&quot;, Nombre = &quot;Juan&quot;, Apellido = &quot;Pérez&quot;, Telefono = &quot;+1234567894&quot;, Password = &quot;estudiante123&quot;, Tipo = &quot;Estudiante&quot; },&#10;                new { Email = &quot;estudiante2@gatekeep.com&quot;, Nombre = &quot;María&quot;, Apellido = &quot;García&quot;, Telefono = &quot;+1234567895&quot;, Password = &quot;estudiante123&quot;, Tipo = &quot;Estudiante&quot; },&#10;                new { Email = &quot;estudiante3@gatekeep.com&quot;, Nombre = &quot;Carlos&quot;, Apellido = &quot;López&quot;, Telefono = &quot;+1234567896&quot;, Password = &quot;estudiante123&quot;, Tipo = &quot;Estudiante&quot; },&#10;                new { Email = &quot;estudiante4@gatekeep.com&quot;, Nombre = &quot;Ana&quot;, Apellido = &quot;Martínez&quot;, Telefono = &quot;+1234567897&quot;, Password = &quot;estudiante123&quot;, Tipo = &quot;Estudiante&quot; },&#10;                new { Email = &quot;estudiante5@gatekeep.com&quot;, Nombre = &quot;Luis&quot;, Apellido = &quot;Rodríguez&quot;, Telefono = &quot;+1234567898&quot;, Password = &quot;estudiante123&quot;, Tipo = &quot;Estudiante&quot; },&#10;                &#10;                // Funcionarios&#10;                new { Email = &quot;funcionario1@gatekeep.com&quot;, Nombre = &quot;Roberto&quot;, Apellido = &quot;Silva&quot;, Telefono = &quot;+1234567899&quot;, Password = &quot;funcionario123&quot;, Tipo = &quot;Funcionario&quot; },&#10;                new { Email = &quot;funcionario2@gatekeep.com&quot;, Nombre = &quot;Patricia&quot;, Apellido = &quot;Morales&quot;, Telefono = &quot;+1234567900&quot;, Password = &quot;funcionario123&quot;, Tipo = &quot;Funcionario&quot; },&#10;                new { Email = &quot;funcionario3@gatekeep.com&quot;, Nombre = &quot;Fernando&quot;, Apellido = &quot;Castro&quot;, Telefono = &quot;+1234567901&quot;, Password = &quot;funcionario123&quot;, Tipo = &quot;Funcionario&quot; },&#10;                new { Email = &quot;funcionario4@gatekeep.com&quot;, Nombre = &quot;Isabel&quot;, Apellido = &quot;Vargas&quot;, Telefono = &quot;+1234567902&quot;, Password = &quot;funcionario123&quot;, Tipo = &quot;Funcionario&quot; }&#10;            };&#10;&#10;            foreach (var usuarioTest in usuariosTest)&#10;            {&#10;                var existing = await repo.GetByEmailAsync(usuarioTest.Email);&#10;                if (existing == null)&#10;                {&#10;                    // Crear usuario nuevo&#10;                    var usuarioDto = new UsuarioDto&#10;                    {&#10;                        Email = usuarioTest.Email,&#10;                        Nombre = usuarioTest.Nombre,&#10;                        Apellido = usuarioTest.Apellido,&#10;                        Contrasenia = passwordService.HashPassword(usuarioTest.Password),&#10;                        Telefono = usuarioTest.Telefono,&#10;                        Rol = usuarioTest.Tipo switch&#10;                        {&#10;                            &quot;Admin&quot; =&gt; GateKeep.Api.Domain.Enums.Rol.Admin,&#10;                            &quot;Estudiante&quot; =&gt; GateKeep.Api.Domain.Enums.Rol.Estudiante,&#10;                            &quot;Funcionario&quot; =&gt; GateKeep.Api.Domain.Enums.Rol.Funcionario,&#10;                            _ =&gt; GateKeep.Api.Domain.Enums.Rol.Estudiante&#10;                        }&#10;                    };&#10;&#10;                    var usuario = factory.CrearUsuario(usuarioDto);&#10;&#10;                    await repo.AddAsync(usuario);&#10;                    usuariosCreados.Add(new { &#10;                        Tipo = usuarioTest.Tipo, &#10;                        Id = usuario.Id, &#10;                        Email = usuario.Email, &#10;                        Nombre = usuario.Nombre, &#10;                        Apellido = usuario.Apellido,&#10;                        Password = usuarioTest.Password,&#10;                        Telefono = usuario.Telefono&#10;                    });&#10;                    totalCreados++;&#10;                }&#10;                else&#10;                {&#10;                    // Usuario ya existe - agregar a lista de existentes&#10;                    usuariosExistentes.Add(new { &#10;                        Tipo = usuarioTest.Tipo, &#10;                        Id = existing.Id, &#10;                        Email = existing.Email, &#10;                        Nombre = existing.Nombre, &#10;                        Apellido = existing.Apellido,&#10;                        Password = usuarioTest.Password,&#10;                        Telefono = existing.Telefono&#10;                    });&#10;                    totalExistentes++;&#10;                }&#10;            }&#10;&#10;            return Results.Ok(new&#10;            {&#10;                IsSuccess = true,&#10;                Message = $&quot;Proceso completado. Creados: {totalCreados}, Existentes: {totalExistentes}&quot;,&#10;                UsuariosCreados = usuariosCreados,&#10;                UsuariosExistentes = usuariosExistentes,&#10;                Resumen = new&#10;                {&#10;                    TotalCreados = totalCreados,&#10;                    TotalExistentes = totalExistentes,&#10;                    TotalProcesados = totalCreados + totalExistentes&#10;                }&#10;            });&#10;        })&#10;        .WithName(&quot;CreateTestUsers&quot;)&#10;        .WithSummary(&quot;Crear usuarios de prueba&quot;)&#10;        .WithDescription(&quot;Crea usuarios de prueba de todos los tipos para testing&quot;)&#10;        .Produces&lt;AuthResponse&gt;(200)&#10;        .Produces(400);&#10;&#10;        // Endpoint para listar usuarios con contraseñas en texto plano&#10;        group.MapGet(&quot;/list-users&quot;, async (IUsuarioRepository repo) =&gt;&#10;        {&#10;            var usuarios = await repo.GetAllAsync();&#10;            &#10;            // Mapear usuarios con contraseñas en texto plano para testing&#10;            var usuariosConPasswords = usuarios.Select(u =&gt; new&#10;            {&#10;                Id = u.Id,&#10;                Email = u.Email,&#10;                Nombre = u.Nombre,&#10;                Apellido = u.Apellido,&#10;                Telefono = u.Telefono,&#10;                TipoUsuario = u.Rol.ToString(),&#10;                FechaAlta = u.FechaAlta,&#10;                Credencial = u.Credencial,&#10;                // Contraseñas en texto plano para testing (solo para desarrollo)&#10;                Password = GetPasswordForTesting(u.Email)&#10;            }).ToList();&#10;&#10;            return Results.Ok(new&#10;            {&#10;                IsSuccess = true,&#10;                Message = $&quot;Se encontraron {usuariosConPasswords.Count} usuarios&quot;,&#10;                TotalUsuarios = usuariosConPasswords.Count,&#10;                Usuarios = usuariosConPasswords&#10;            });&#10;        })&#10;        .WithName(&quot;ListUsers&quot;)&#10;        .WithSummary(&quot;Listar usuarios&quot;)&#10;        .WithDescription(&quot;Lista todos los usuarios con contraseñas en texto plano para testing&quot;)&#10;        .Produces(200)&#10;        .Produces(400);&#10;&#10;        return app;&#10;    }&#10;&#10;    // Método auxiliar para obtener contraseñas de testing&#10;    private static string GetPasswordForTesting(string email)&#10;    {&#10;        // Mapeo de contraseñas para testing basado en el email&#10;        return email switch&#10;        {&#10;            var e when e.Contains(&quot;admin&quot;) =&gt; &quot;admin123&quot;,&#10;            var e when e.Contains(&quot;estudiante&quot;) =&gt; &quot;estudiante123&quot;,&#10;            var e when e.Contains(&quot;funcionario&quot;) =&gt; &quot;funcionario123&quot;,&#10;            _ =&gt; &quot;password123&quot; // Contraseña por defecto&#10;        };&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="using GateKeep.Api.Contracts.Security;&#13;&#10;using GateKeep.Api.Contracts.Usuarios;&#13;&#10;using GateKeep.Api.Application.Security;&#13;&#10;using GateKeep.Api.Application.Usuarios;&#13;&#10;using GateKeep.Infrastructure.QrCodes;&#13;&#10;using System.Security.Claims;&#13;&#10;&#13;&#10;namespace GateKeep.Api.Endpoints.Auth;&#13;&#10;&#13;&#10;public static class AuthEndpoints&#13;&#10;{&#13;&#10;    public static IEndpointRouteBuilder MapAuthEndpoints(this IEndpointRouteBuilder app)&#13;&#10;    {&#13;&#10;        var group = app.MapGroup(&quot;/auth&quot;).WithTags(&quot;Authentication&quot;);&#13;&#10;&#13;&#10;        // Login endpoint - PÚBLICO (sin restricciones de seguridad)&#13;&#10;        group.MapPost(&quot;/login&quot;, async (LoginRequest request, IAuthService authService) =&gt;&#13;&#10;        {&#13;&#10;            if (string.IsNullOrEmpty(request.Email) || string.IsNullOrEmpty(request.Password))&#13;&#10;            {&#13;&#10;                return Results.BadRequest(new AuthResponse&#13;&#10;                {&#13;&#10;                    IsSuccess = false,&#13;&#10;                    ErrorMessage = &quot;Email y contraseña son requeridos&quot;&#13;&#10;                });&#13;&#10;            }&#13;&#10;&#13;&#10;            var result = await authService.LoginAsync(request.Email, request.Password);&#13;&#10;            &#13;&#10;            if (!result.IsSuccess)&#13;&#10;            {&#13;&#10;                return Results.Unauthorized();&#13;&#10;            }&#13;&#10;&#13;&#10;            var response = new AuthResponse&#13;&#10;            {&#13;&#10;                IsSuccess = true,&#13;&#10;                Token = result.Token,&#13;&#10;                RefreshToken = result.RefreshToken,&#13;&#10;                ExpiresAt = result.ExpiresAt,&#13;&#10;                User = new UserInfoResponse&#13;&#10;                {&#13;&#10;                    Id = result.User!.Id,&#13;&#10;                    Email = result.User.Email,&#13;&#10;                    Nombre = result.User.Nombre,&#13;&#10;                    Apellido = result.User.Apellido,&#13;&#10;                    TipoUsuario = result.User.Rol.ToString(),&#13;&#10;                    Telefono = result.User.Telefono,&#13;&#10;                    FechaAlta = result.User.FechaAlta&#13;&#10;                }&#13;&#10;            };&#13;&#10;&#13;&#10;            return Results.Ok(response);&#13;&#10;        })&#13;&#10;        .AllowAnonymous()&#13;&#10;        .WithName(&quot;Login&quot;)&#13;&#10;        .WithSummary(&quot;Iniciar sesión&quot;)&#13;&#10;        .WithDescription(&quot;Autentica un usuario y retorna un token JWT. Endpoint público sin restricciones de seguridad.&quot;)&#13;&#10;        .Produces&lt;AuthResponse&gt;(200)&#13;&#10;        .Produces(401)&#13;&#10;        .Produces(400);&#13;&#10;&#13;&#10;        // Register endpoint - SOLO ADMINS&#13;&#10;        group.MapPost(&quot;/register&quot;, async (RegisterRequest request, IAuthService authService) =&gt;&#13;&#10;        {&#13;&#10;            if (string.IsNullOrEmpty(request.Email) || string.IsNullOrEmpty(request.Password) ||&#13;&#10;                string.IsNullOrEmpty(request.Nombre) || string.IsNullOrEmpty(request.Apellido))&#13;&#10;            {&#13;&#10;                return Results.BadRequest(new AuthResponse&#13;&#10;                {&#13;&#10;                    IsSuccess = false,&#13;&#10;                    ErrorMessage = &quot;Email, contraseña, nombre y apellido son requeridos&quot;&#13;&#10;                });&#13;&#10;            }&#13;&#10;&#13;&#10;            if (request.Password != request.ConfirmPassword)&#13;&#10;            {&#13;&#10;                return Results.BadRequest(new AuthResponse&#13;&#10;                {&#13;&#10;                    IsSuccess = false,&#13;&#10;                    ErrorMessage = &quot;Las contraseñas no coinciden&quot;&#13;&#10;                });&#13;&#10;            }&#13;&#10;&#13;&#10;            var result = await authService.RegisterAsync(&#13;&#10;                request.Email,&#13;&#10;                request.Password,&#13;&#10;                request.Nombre,&#13;&#10;                request.Apellido,&#13;&#10;                request.Telefono,&#13;&#10;                request.Rol&#13;&#10;            );&#13;&#10;            &#13;&#10;            if (!result.IsSuccess)&#13;&#10;            {&#13;&#10;                return Results.BadRequest(new AuthResponse&#13;&#10;                {&#13;&#10;                    IsSuccess = false,&#13;&#10;                    ErrorMessage = result.ErrorMessage ?? &quot;Error al registrar el usuario&quot;&#13;&#10;                });&#13;&#10;            }&#13;&#10;&#13;&#10;            var response = new AuthResponse&#13;&#10;            {&#13;&#10;                IsSuccess = true,&#13;&#10;                Token = result.Token,&#13;&#10;                RefreshToken = result.RefreshToken,&#13;&#10;                ExpiresAt = result.ExpiresAt,&#13;&#10;                User = new UserInfoResponse&#13;&#10;                {&#13;&#10;                    Id = result.User!.Id,&#13;&#10;                    Email = result.User.Email,&#13;&#10;                    Nombre = result.User.Nombre,&#13;&#10;                    Apellido = result.User.Apellido,&#13;&#10;                    TipoUsuario = result.User.Rol.ToString(),&#13;&#10;                    Telefono = result.User.Telefono,&#13;&#10;                    FechaAlta = result.User.FechaAlta&#13;&#10;                }&#13;&#10;            };&#13;&#10;&#13;&#10;            return Results.Ok(response);&#13;&#10;        })&#13;&#10;        .WithName(&quot;Register&quot;)&#13;&#10;        .WithSummary(&quot;Registrar nuevo usuario&quot;)&#13;&#10;        .WithDescription(&quot;Registra un nuevo usuario en el sistema. Solo accesible por Administradores.&quot;)&#13;&#10;        .Produces&lt;AuthResponse&gt;(200)&#13;&#10;        .Produces(400)&#13;&#10;        .Produces(401)&#13;&#10;        .RequireAuthorization(&quot;AdminOnly&quot;);&#13;&#10;&#13;&#10;        // Generar código QR con el JWT actual&#13;&#10;        group.MapGet(&quot;/qr&quot;, (&#13;&#10;            HttpContext httpContext,&#13;&#10;            QrCodeGenerator qr&#13;&#10;        ) =&gt;&#13;&#10;        {&#13;&#10;            // 1) Permitir token explícito por query: /auth/qr?token=...&#13;&#10;            string? token = httpContext.Request.Query[&quot;token&quot;];&#13;&#10;&#13;&#10;            // 2) Si no viene por query, intentar extraer del header Authorization: Bearer &lt;token&gt;&#13;&#10;            if (string.IsNullOrWhiteSpace(token))&#13;&#10;            {&#13;&#10;                if (httpContext.Request.Headers.TryGetValue(&quot;Authorization&quot;, out var authHeader))&#13;&#10;                {&#13;&#10;                    var value = authHeader.ToString();&#13;&#10;                    const string prefix = &quot;Bearer &quot;;&#13;&#10;                    if (value.StartsWith(prefix, StringComparison.OrdinalIgnoreCase))&#13;&#10;                    {&#13;&#10;                        token = value.Substring(prefix.Length).Trim();&#13;&#10;                    }&#13;&#10;                }&#13;&#10;            }&#13;&#10;&#13;&#10;            if (string.IsNullOrWhiteSpace(token))&#13;&#10;            {&#13;&#10;                return Results.BadRequest(new { message = &quot;Falta el token JWT (use query 'token' o Authorization: Bearer ...)&quot; });&#13;&#10;            }&#13;&#10;&#13;&#10;            // Generar PNG con el token (solo Windows por dependencia de System.Drawing)&#13;&#10;            if (!OperatingSystem.IsWindows())&#13;&#10;            {&#13;&#10;                return Results.Problem(&quot;Generación de QR no soportada en esta plataforma (requiere Windows)&quot;, statusCode: 501);&#13;&#10;            }&#13;&#10;&#13;&#10;            // Tamaño opcional del QR: ?w=250&amp;h=250&#13;&#10;            int w = 250;&#13;&#10;            int h = 250;&#13;&#10;            if (int.TryParse(httpContext.Request.Query[&quot;w&quot;], out var wParsed) &amp;&amp; wParsed &gt; 0)&#13;&#10;            {&#13;&#10;                w = wParsed;&#13;&#10;            }&#13;&#10;            if (int.TryParse(httpContext.Request.Query[&quot;h&quot;], out var hParsed) &amp;&amp; hParsed &gt; 0)&#13;&#10;            {&#13;&#10;                h = hParsed;&#13;&#10;            }&#13;&#10;&#13;&#10;            var pngBytes = qr.Generate(token, w, h);&#13;&#10;            return Results.File(pngBytes, contentType: &quot;image/png&quot;, fileDownloadName: null, enableRangeProcessing: false);&#13;&#10;        })&#13;&#10;        .WithName(&quot;GetAuthTokenQr&quot;)&#13;&#10;        .WithSummary(&quot;Generar código QR del JWT&quot;)&#13;&#10;        .WithDescription(&quot;Devuelve una imagen PNG con el QR que contiene el token JWT. Acepta query 'token' o usa el header Authorization.&quot;)&#13;&#10;        .Produces(200)&#13;&#10;        .Produces(400)&#13;&#10;        .RequireAuthorization();&#13;&#10;&#13;&#10;        // Crear usuarios de prueba - PÚBLICO (para testing)&#13;&#10;        group.MapPost(&quot;/create-test-users&quot;, async (&#13;&#10;            IUsuarioFactory factory, &#13;&#10;            IUsuarioRepository repo,&#13;&#10;            IPasswordService passwordService) =&gt;&#13;&#10;        {&#13;&#10;            var usuariosCreados = new List&lt;object&gt;();&#13;&#10;            var usuariosExistentes = new List&lt;object&gt;();&#13;&#10;            var totalCreados = 0;&#13;&#10;            var totalExistentes = 0;&#13;&#10;&#13;&#10;            // Datos de usuarios de prueba con contraseñas en texto plano&#13;&#10;            var usuariosTest = new[]&#13;&#10;            {&#13;&#10;                // Administradores&#13;&#10;                new { Email = &quot;admin1@gatekeep.com&quot;, Nombre = &quot;Admin&quot;, Apellido = &quot;Uno&quot;, Telefono = &quot;+1234567891&quot;, Password = &quot;admin123&quot;, Tipo = &quot;Admin&quot; },&#13;&#10;                new { Email = &quot;admin2@gatekeep.com&quot;, Nombre = &quot;Admin&quot;, Apellido = &quot;Dos&quot;, Telefono = &quot;+1234567892&quot;, Password = &quot;admin123&quot;, Tipo = &quot;Admin&quot; },&#13;&#10;                new { Email = &quot;admin3@gatekeep.com&quot;, Nombre = &quot;Admin&quot;, Apellido = &quot;Tres&quot;, Telefono = &quot;+1234567893&quot;, Password = &quot;admin123&quot;, Tipo = &quot;Admin&quot; },&#13;&#10;                &#13;&#10;                // Estudiantes&#13;&#10;                new { Email = &quot;estudiante1@gatekeep.com&quot;, Nombre = &quot;Juan&quot;, Apellido = &quot;Pérez&quot;, Telefono = &quot;+1234567894&quot;, Password = &quot;estudiante123&quot;, Tipo = &quot;Estudiante&quot; },&#13;&#10;                new { Email = &quot;estudiante2@gatekeep.com&quot;, Nombre = &quot;María&quot;, Apellido = &quot;García&quot;, Telefono = &quot;+1234567895&quot;, Password = &quot;estudiante123&quot;, Tipo = &quot;Estudiante&quot; },&#13;&#10;                new { Email = &quot;estudiante3@gatekeep.com&quot;, Nombre = &quot;Carlos&quot;, Apellido = &quot;López&quot;, Telefono = &quot;+1234567896&quot;, Password = &quot;estudiante123&quot;, Tipo = &quot;Estudiante&quot; },&#13;&#10;                new { Email = &quot;estudiante4@gatekeep.com&quot;, Nombre = &quot;Ana&quot;, Apellido = &quot;Martínez&quot;, Telefono = &quot;+1234567897&quot;, Password = &quot;estudiante123&quot;, Tipo = &quot;Estudiante&quot; },&#13;&#10;                new { Email = &quot;estudiante5@gatekeep.com&quot;, Nombre = &quot;Luis&quot;, Apellido = &quot;Rodríguez&quot;, Telefono = &quot;+1234567898&quot;, Password = &quot;estudiante123&quot;, Tipo = &quot;Estudiante&quot; },&#13;&#10;                &#13;&#10;                // Funcionarios&#13;&#10;                new { Email = &quot;funcionario1@gatekeep.com&quot;, Nombre = &quot;Roberto&quot;, Apellido = &quot;Silva&quot;, Telefono = &quot;+1234567899&quot;, Password = &quot;funcionario123&quot;, Tipo = &quot;Funcionario&quot; },&#13;&#10;                new { Email = &quot;funcionario2@gatekeep.com&quot;, Nombre = &quot;Patricia&quot;, Apellido = &quot;Morales&quot;, Telefono = &quot;+1234567900&quot;, Password = &quot;funcionario123&quot;, Tipo = &quot;Funcionario&quot; },&#13;&#10;                new { Email = &quot;funcionario3@gatekeep.com&quot;, Nombre = &quot;Fernando&quot;, Apellido = &quot;Castro&quot;, Telefono = &quot;+1234567901&quot;, Password = &quot;funcionario123&quot;, Tipo = &quot;Funcionario&quot; },&#13;&#10;                new { Email = &quot;funcionario4@gatekeep.com&quot;, Nombre = &quot;Isabel&quot;, Apellido = &quot;Vargas&quot;, Telefono = &quot;+1234567902&quot;, Password = &quot;funcionario123&quot;, Tipo = &quot;Funcionario&quot; }&#13;&#10;            };&#13;&#10;&#13;&#10;            foreach (var usuarioTest in usuariosTest)&#13;&#10;            {&#13;&#10;                var existing = await repo.GetByEmailAsync(usuarioTest.Email);&#13;&#10;                if (existing == null)&#13;&#10;                {&#13;&#10;                    // Crear usuario nuevo&#13;&#10;                    var usuarioDto = new UsuarioDto&#13;&#10;                    {&#13;&#10;                        Email = usuarioTest.Email,&#13;&#10;                        Nombre = usuarioTest.Nombre,&#13;&#10;                        Apellido = usuarioTest.Apellido,&#13;&#10;                        Contrasenia = passwordService.HashPassword(usuarioTest.Password),&#13;&#10;                        Telefono = usuarioTest.Telefono,&#13;&#10;                        Rol = usuarioTest.Tipo switch&#13;&#10;                        {&#13;&#10;                            &quot;Admin&quot; =&gt; GateKeep.Api.Domain.Enums.Rol.Admin,&#13;&#10;                            &quot;Estudiante&quot; =&gt; GateKeep.Api.Domain.Enums.Rol.Estudiante,&#13;&#10;                            &quot;Funcionario&quot; =&gt; GateKeep.Api.Domain.Enums.Rol.Funcionario,&#13;&#10;                            _ =&gt; GateKeep.Api.Domain.Enums.Rol.Estudiante&#13;&#10;                        }&#13;&#10;                    };&#13;&#10;&#13;&#10;                    var usuario = factory.CrearUsuario(usuarioDto);&#13;&#10;&#13;&#10;                    await repo.AddAsync(usuario);&#13;&#10;                    usuariosCreados.Add(new { &#13;&#10;                        Tipo = usuarioTest.Tipo, &#13;&#10;                        Id = usuario.Id, &#13;&#10;                        Email = usuario.Email, &#13;&#10;                        Nombre = usuario.Nombre, &#13;&#10;                        Apellido = usuario.Apellido,&#13;&#10;                        Password = usuarioTest.Password,&#13;&#10;                        Telefono = usuario.Telefono&#13;&#10;                    });&#13;&#10;                    totalCreados++;&#13;&#10;                }&#13;&#10;                else&#13;&#10;                {&#13;&#10;                    // Usuario ya existe - agregar a lista de existentes&#13;&#10;                    usuariosExistentes.Add(new { &#13;&#10;                        Tipo = usuarioTest.Tipo, &#13;&#10;                        Id = existing.Id, &#13;&#10;                        Email = existing.Email, &#13;&#10;                        Nombre = existing.Nombre, &#13;&#10;                        Apellido = existing.Apellido,&#13;&#10;                        Password = usuarioTest.Password,&#13;&#10;                        Telefono = existing.Telefono&#13;&#10;                    });&#13;&#10;                    totalExistentes++;&#13;&#10;                }&#13;&#10;            }&#13;&#10;&#13;&#10;            return Results.Ok(new&#13;&#10;            {&#13;&#10;                IsSuccess = true,&#13;&#10;                Message = $&quot;Proceso completado. Creados: {totalCreados}, Existentes: {totalExistentes}&quot;,&#13;&#10;                UsuariosCreados = usuariosCreados,&#13;&#10;                UsuariosExistentes = usuariosExistentes,&#13;&#10;                Resumen = new&#13;&#10;                {&#13;&#10;                    TotalCreados = totalCreados,&#13;&#10;                    TotalExistentes = totalExistentes,&#13;&#10;                    TotalProcesados = totalCreados + totalExistentes&#13;&#10;                }&#13;&#10;            });&#13;&#10;        })&#13;&#10;        .WithName(&quot;CreateTestUsers&quot;)&#13;&#10;        .WithSummary(&quot;Crear usuarios de prueba&quot;)&#13;&#10;        .WithDescription(&quot;Crea usuarios de prueba de todos los tipos para testing&quot;)&#13;&#10;        .Produces&lt;AuthResponse&gt;(200)&#13;&#10;        .Produces(400);&#13;&#10;&#13;&#10;        // Endpoint para listar usuarios con contraseñas en texto plano&#13;&#10;        group.MapGet(&quot;/list-users&quot;, async (IUsuarioRepository repo) =&gt;&#13;&#10;        {&#13;&#10;            var usuarios = await repo.GetAllAsync();&#13;&#10;            &#13;&#10;            // Mapear usuarios con contraseñas en texto plano para testing&#13;&#10;            var usuariosConPasswords = usuarios.Select(u =&gt; new&#13;&#10;            {&#13;&#10;                Id = u.Id,&#13;&#10;                Email = u.Email,&#13;&#10;                Nombre = u.Nombre,&#13;&#10;                Apellido = u.Apellido,&#13;&#10;                Telefono = u.Telefono,&#13;&#10;                TipoUsuario = u.Rol.ToString(),&#13;&#10;                FechaAlta = u.FechaAlta,&#13;&#10;                Credencial = u.Credencial,&#13;&#10;                // Contraseñas en texto plano para testing (solo para desarrollo)&#13;&#10;                Password = GetPasswordForTesting(u.Email)&#13;&#10;            }).ToList();&#13;&#10;&#13;&#10;            return Results.Ok(new&#13;&#10;            {&#13;&#10;                IsSuccess = true,&#13;&#10;                Message = $&quot;Se encontraron {usuariosConPasswords.Count} usuarios&quot;,&#13;&#10;                TotalUsuarios = usuariosConPasswords.Count,&#13;&#10;                Usuarios = usuariosConPasswords&#13;&#10;            });&#13;&#10;        })&#13;&#10;        .WithName(&quot;ListUsers&quot;)&#13;&#10;        .WithSummary(&quot;Listar usuarios&quot;)&#13;&#10;        .WithDescription(&quot;Lista todos los usuarios con contraseñas en texto plano para testing&quot;)&#13;&#10;        .Produces(200)&#13;&#10;        .Produces(400);&#13;&#10;&#13;&#10;        return app;&#13;&#10;    }&#13;&#10;&#13;&#10;    // Método auxiliar para obtener contraseñas de testing&#13;&#10;    private static string GetPasswordForTesting(string email)&#13;&#10;    {&#13;&#10;        // Mapeo de contraseñas para testing basado en el email&#13;&#10;        return email switch&#13;&#10;        {&#13;&#10;            var e when e.Contains(&quot;admin&quot;) =&gt; &quot;admin123&quot;,&#13;&#10;            var e when e.Contains(&quot;estudiante&quot;) =&gt; &quot;estudiante123&quot;,&#13;&#10;            var e when e.Contains(&quot;funcionario&quot;) =&gt; &quot;funcionario123&quot;,&#13;&#10;            _ =&gt; &quot;password123&quot; // Contraseña por defecto&#13;&#10;        };&#13;&#10;    }&#13;&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>