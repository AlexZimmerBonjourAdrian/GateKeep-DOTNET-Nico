version: '3.8'

networks:
  gatekeep-network:
    driver: bridge

services:
  postgres:
    image: postgres:16-alpine
    container_name: gatekeep-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: Gatekeep
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD:-GateKeep2024!}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - gatekeep-network

  redis:
    image: redis:7-alpine
    container_name: gatekeep-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - gatekeep-network

  mongodb:
    image: mongo:7.0
    container_name: gatekeep-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    networks:
      - gatekeep-network

  api:
    build:
      context: ./Gatekeep/src
      dockerfile: Dockerfile
    container_name: gatekeep-api
    restart: unless-stopped
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: "http://+:5011"
      DATABASE__HOST: postgres
      DATABASE__PORT: 5432
      DATABASE__NAME: Gatekeep
      DATABASE__USER: postgres
      DATABASE__PASSWORD: ${DB_PASSWORD:-GateKeep2024!}
      REDIS__CONNECTIONSTRING: redis:6379
      MONGODB_CONNECTION: mongodb://mongodb:27017
      JWT__KEY: ${JWT_KEY:-tu-clave-jwt-super-secreta-de-256-bits-minimo}
    ports:
      - "5011:5011"
    depends_on:
      - postgres
      - redis
      - mongodb
    networks:
      - gatekeep-network

  frontend:
    build:
      context: ./Gatekeep/frontend
      dockerfile: Dockerfile
    container_name: gatekeep-frontend
    restart: unless-stopped
    environment:
      NODE_ENV: production
      # Con nginx, el frontend debe usar http://localhost (nginx enruta /api/ al backend)
      # Sin nginx, usar http://localhost:5011 directamente
      NEXT_PUBLIC_API_URL: http://localhost
    ports:
      - "3000:3000"
    depends_on:
      - api
    networks:
      - gatekeep-network

  nginx:
    image: nginx:alpine
    container_name: gatekeep-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - frontend
      - api
    networks:
      - gatekeep-network

volumes:
  postgres_data:
  redis_data:
  mongodb_data: